---
blog: true
date: 2020-06-11
title: 用Python提取新闻联播摘要和关键字
categories: [Python]
tags: [摘要,CCTV,jieba,jiagu]
draft: false
---

对一个业余投资爱好者来说，看新闻联播可比什么K线布林小道要有意义的多，传说会看新闻联播能少走十年弯路，我是深信不疑啊。

但我们不愿意蹲点看视频，还是文字报道读起来快，如果能有个摘要那就更好了，要是能有关键字提取，还能回顾一段时间的关键字，那岂不是时间轴都有了，啧啧，完美掌握国家政策趋势。

## 内容
由于是给hugo静态网站添加内容，按照hugo模板生成一个文件即可。

文件内容主要有两部分组成

1. 今日关键字：由全天报道的所有内容自动生成，选取今日最佳关键字。另外针对投资领域，我们把指数名称、板块和行业等也做了关键字整理，如果发现这些关键字，也做高亮提示
2. 新闻摘要：每篇报道的内容文字可能比较多，我们提取最关键的两句

新闻源采用tushare的新闻联播接口。

中文的分词和摘要采用jiagu。

## 运行环境

Github全家桶的Action功能（真香啊），可以完整打开一个docker进程。

1. 定时运行Python脚本拉取新闻数据
2. Hugo生成静态文件
3. 提交repo

~~## 网站内容自动更新~~

~~本地定时git pull，启动docker运行hugo生成内容。~~


## 关键代码

获取新闻
```
author:公众号：结丹记事本儿
TOKEN = 'xxxx9841ad3c28d1xxx1da86fe73xxx1ec4'
import tushare as ts

ts.set_token(TOKEN)
pro = ts.pro_api()
news = pro.cctv_news(date='20200610')
```

元数据处理
```
#date
from datetime import datetime, timedelta
yesterday = datetime.today() - timedelta(days=1)
yesterday = yesterday.strftime('%Y-%m-%d')
today = datetime.today().strftime('%Y-%m-%d')

#title
title = 'CCTV新闻联播摘要{date}'.format(date=yesterday)

# keywords
text = ''.join(news.iloc[:,2].to_list())
keywords = jiagu.keywords(text, 7) # 关键词
keywords = [x for x in keywords if len(x)>=2]
keywords = ','.join(keywords)

#content
import jiagu
reports = []
for text in news.iloc[:,2].to_list():
    reports.append(''.join(jiagu.summarize(text,2)))

content = '\r\n\r\n'.join(reports)

#强调关键字
keys = keywords.split(',')
for k in keys:
    content = content.replace(k, '<span style="border-bottom:4px solid orange;">'+k+'</span>')

for k in KEYS:
    content = content.replace(k, '<span style="border-bottom:4px solid oceanblue;">'+k+'</span>')
```

**模板写入文件**
```
tpl = '''

---
title: {title}
date: {date}
tags: [CCTV, 新闻, {keywords}]
draft: false
---
{content}
'''
md = tpl.format(
    title=title,
    date=today,
    keywords=keywords,
    content=content
)

open(title+'.md', 'w').write(md)
```

**Github ci文件**
```
# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Python application

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 22 * * *'

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install tushare jiagu 
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        apt install hugo
    - name: pull yesterday cctv news
      run: |
        # stop the build if there are Python syntax errors or undefined names
        python3 /bin/pull_cctv_news.py 'content/news/'
    - name: update static files by hugo
      run: |
        # stop the build if there are Python syntax errors or undefined names
        hugo
    - name: Commit changes
      uses: EndBug/add-and-commit@v4
      with:
        author_name: 52etf.net
        author_email: admin@52etf.net
        message: "日更一卒"
        add: "/content/news/"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

```